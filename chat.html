<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scroll */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        /* Ensure all elements include padding and border in their total size */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Top Header Bar */
        .header {
            width: 100%;
            background: linear-gradient(to right, #4CAF50, #66BB6A);
            padding: 15px 20px;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 20;
            box-sizing: border-box;
        }
        .header .user-info { display: flex; align-items: center; font-size: 1.1em; font-weight: 500; }
        .header .user-info i { margin-right: 10px; font-size: 1.3em; }

        .header .user-actions {
            display: flex;
            align-items: center;
            gap: 15px; 
        }
        
        .header .dm-icon,
        .header .logout-icon { 
            color: #fff; 
            font-size: 1.5em; 
            cursor: pointer; 
            padding: 5px; 
            border-radius: 5px; 
            transition: background-color 0.3s ease; 
        }
        .header .dm-icon:hover,
        .header .logout-icon:hover { 
            background-color: rgba(255, 255, 255, 0.2); 
        }
        
        /* Style for the verified tick in header */
        .header .verified-tick-header {
            width: 14px; 
            height: 14px; 
            vertical-align: middle;
            margin-left: 3px; 
            fill: #fff;
        }

        /* Main Content Area */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            margin-top: 80px; /* Space for fixed top header */
            margin-bottom: 70px; /* Space for fixed bottom footer */
            box-sizing: border-box;
            width: 100%;
            max-width: 600px; /* Max width for larger screens */
            margin-left: auto;
            margin-right: auto;
            display: flex;
            flex-direction: column;
            align-items: center; /* Center content horizontally */
        }

        .chat-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            width: 100%; /* Takes full available width */
            max-width: 500px; /* Max width for the chat area itself */
            box-sizing: border-box;
            display: flex; /* Make chat container a flex container */
            flex-direction: column; /* Arrange content vertically */
            
            /* Responsive height calculation */
            height: calc(100vh - 150px); 
            min-height: 400px; /* Minimum height for chat on smaller screens */
        }

        .chat-container h2 {
            color: #4CAF50;
            font-size: 1.8em;
            margin-bottom: 5px; /* Reduced margin */
            display: flex; /* To align username and tick */
            justify-content: center;
            align-items: center;
            gap: 5px; /* Space between username and tick */
            flex-shrink: 0; /* Prevent title from shrinking */
            text-align: center; /* Center text if only one line */
        }

        .recipient-status {
            font-size: 0.9em;
            color: #777;
            text-align: center;
            margin-bottom: 15px; /* Space between status and messages */
            flex-shrink: 0;
            display: flex; /* To align text and dot */
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .chat-message-area {
            flex-grow: 1; /* Allows message area to take up available space */
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px; /* Slightly reduced margin before input area */
            text-align: left;
            overflow-y: auto; /* Enable scrolling for messages */
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column; /* Messages stack vertically */
            gap: 8px; /* Space between messages */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            position: relative; /* For reaction picker positioning */
        }

        .message-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .message-row {
            display: flex;
            align-items: flex-end; /* Align bubble and dots */
            gap: 5px; /* Space between bubble and dots */
            justify-content: flex-start; /* **All messages now align to the left** */
        }
        
        /* NEW: Avatar for recipient messages */
        .message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 8px; /* Space between avatar and message bubble */
            flex-shrink: 0; /* Prevent shrinking */
        }
        /* END NEW */

        .message-bubble {
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 75%; /* Allow bubbles to be a bit wider for readability */
            word-wrap: break-word; /* Ensure long words break */
            position: relative; /* For timestamp positioning and reactions */
            display: flex; 
            flex-direction: column; /* To stack name and content */
            flex-grow: 1; /* Allows bubble to take available space in its row */
            min-width: 100px; /* Prevent shrinking too much */
        }

        /* SENT messages will now be on the left and white */
        .message-row.sent .message-bubble {
            background-color: #ffffff; /* White for sent messages */
            border: 1px solid #e0e0e0; /* Subtle border for sent */
        }

        /* RECEIVED messages will now be on the left and light green */
        .message-row.received .message-bubble {
            background-color: #dcf8c6; /* Light green for received messages */
        }

        .message-sender-in-bubble {
            font-size: 0.7em; /* Small size */
            margin-bottom: 3px; /* Small space between name and message */
            opacity: 0.8; /* Slightly faded */
            color: #777; /* Default color for recipient's name */
        }

        /* "You" for sent messages, which are now left-aligned */
        .message-row.sent .message-sender-in-bubble {
            align-self: flex-start; /* Align "You" to the left within its bubble */
            color: #007bff; /* Blue color for "You" */
        }
        
        /* Recipient's name for received messages, which are now right-aligned */
        /* Since both are left-aligned, this might not be as visually distinct */
        .message-row.received .message-sender-in-bubble {
            align-self: flex-start; /* Align recipient name to the left within its bubble */
        }


        .message-content-wrapper {
            display: flex;
            align-items: flex-end; /* Align text and timestamp/tick to the bottom */
            gap: 5px; /* Space between text and timestamp/tick */
            width: 100%; /* Take full width of bubble */
        }

        /* Content for sent messages (now left-aligned) */
        .message-row.sent .message-content-wrapper {
             justify-content: flex-start; /* Content aligned to start within bubble */
        }

        /* Content for received messages (now left-aligned) */
        .message-row.received .message-content-wrapper {
             justify-content: flex-start; /* Content aligned to start within bubble */
        }


        .message-text {
            word-wrap: break-word;
            flex-grow: 1; /* Allow text to take up available space */
        }

        .message-metadata {
            display: flex;
            align-items: center;
            gap: 3px; /* Space between timestamp and tick */
            white-space: nowrap; /* Keep timestamp and tick on one line */
            font-size: 0.7em;
            color: #888;
        }

        /* General tick styling */
        .seen-tick svg {
            width: 12px;
            height: 12px;
            fill: #aaa; /* Default grey for sent/delivered */
            vertical-align: middle;
        }

        /* Specific styling for when a message is actually "seen" */
        .message-bubble.seen .seen-tick svg { /* Apply to all seen messages, regardless of sender */
             fill: #F44336; /* Red for seen tick as requested */
        }
        
        /* Hidden by default, shown for sent messages (even single tick) */
        .message-bubble.sent .seen-tick {
            display: inline-block; 
        }
        .message-bubble.received .seen-tick {
            display: none; /* Never show ticks on received messages */
        }

        /* Reactions container (summary below message) */
        .message-reactions {
            margin-top: 5px; /* Space below the message bubble */
            margin-bottom: 5px;
            display: flex;
            gap: 5px;
            font-size: 0.85em;
            flex-wrap: wrap; /* Allow reactions to wrap */
            align-self: flex-start; /* Align summary to the left */
        }

        .message-reactions .reaction-item {
            background: rgba(0, 0, 0, 0.05); /* Light background for each reaction */
            border-radius: 12px;
            padding: 2px 7px;
            display: flex;
            align-items: center;
            gap: 3px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .message-reactions .reaction-emoji {
            font-size: 1.1em;
            vertical-align: middle;
        }
        .message-reactions .reaction-count {
            font-size: 0.9em;
            color: #555;
        }


        /* Three Dot Icon for Reactions */
        .reaction-dots-icon {
            font-size: 1em;
            color: #aaa;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
            align-self: center; /* Vertically align with bubble */
        }
        .reaction-dots-icon:hover {
            background-color: rgba(0,0,0,0.05);
        }

        /* Reaction Emojis Row (visible when dots are clicked) */
        .reactions-row {
            display: none; /* Hidden by default */
            background-color: #fff;
            border: 1px solid #eee;
            border-radius: 15px;
            padding: 8px 10px;
            margin-top: 5px;
            margin-bottom: 5px; /* Space below the row */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            justify-content: space-around;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap; /* Allow emojis to wrap on smaller screens */
            animation: fadeInScale 0.2s ease-out forwards;
            align-self: flex-start; /* Align reactions row to the left */
        }

        .reactions-row.visible {
            display: flex;
        }

        .reactions-row .emoji {
            font-size: 1.6em; /* Emojis in the row */
            cursor: pointer;
            transition: transform 0.1s ease;
        }

        .reactions-row .emoji:hover {
            transform: scale(1.2);
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .chat-input-area {
            display: flex;
            align-items: center; /* Vertically align input and button */
            position: relative; /* For send icon positioning */
            flex-shrink: 0; /* Prevent input area from shrinking */
        }

        .chat-input-area input[type="text"] {
            flex-grow: 1;
            padding: 10px 40px 10px 15px; /* Right padding for send icon */
            border: 1px solid #ddd;
            border-radius: 20px; /* More rounded input */
            font-size: 1em;
            outline: none;
            width: calc(100% - 45px); /* Adjusted width for input box */
        }
        .chat-input-area input[type="text"]:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .chat-input-area .send-icon-btn {
            background: none;
            border: none;
            color: #4CAF50;
            font-size: 1.5em;
            cursor: pointer;
            position: absolute;
            right: 10px; /* Position inside the input box */
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-input-area .send-icon-btn:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }
        .chat-input-area .send-icon-btn:disabled {
            color: #ccc;
            cursor: not-allowed;
            background: none;
        }


        /* Verified tick SVG styling */
        .verified-tick-chat {
            width: 18px; /* Slightly larger for main chat header */
            height: 18px; 
            vertical-align: middle;
            fill: #4CAF50; /* Green color */
        }

        /* Online dot SVG styling */
        .online-dot {
            width: 8px; /* Size of the dot */
            height: 8px;
            fill: #4CAF50; /* Green color for online */
            vertical-align: middle;
            margin-left: 5px; /* Space from text */
        }

        /* Typing indicator bubble */
        .typing-indicator-bubble {
            background-color: #e0e0e0; /* Light grey background */
            align-self: flex-start; /* Align to the left, like a received message */
            margin-right: auto;
            color: #333;
            font-style: italic;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 75%;
            word-wrap: break-word;
            position: relative; /* For positioning relative to avatar */
        }
        /* Style for typing indicator's avatar */
        .typing-indicator-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 8px;
        }

        /* Typing dots animation */
        .typing-indicator-bubble .dot {
            width: 6px;
            height: 6px;
            background-color: #777;
            border-radius: 50%;
            opacity: 0;
            animation: dot-fade 1.5s infinite ease-in-out;
        }

        .typing-indicator-bubble .dot:nth-child(1) {
            animation-delay: 0s; /* Start immediately */
        }
        .typing-indicator-bubble .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator-bubble .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes dot-fade {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }

        /* Bottom Navigation Bar */
        .footer {
            width: 100%;
            background: linear-gradient(to right, #4CAF50, #66BB6A);
            padding: 15px 0;
            color: #fff;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2);
            position: fixed;
            bottom: 0;
            left: 0;
            z-index: 20;
            box-sizing: border-box;
        }
        .footer .nav-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #fff;
            font-size: 0.8em;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            transition: background-color 0.3s ease, color 0.3s ease;
            flex: 1; /* Distribute space evenly */
            text-align: center;
        }
        .footer .nav-icon i { font-size: 1.5em; margin-bottom: 5px; }
        .footer .nav-icon:hover { background-color: rgba(255, 255, 255, 0.2); }
        .footer .nav-icon.active { color: #c8e6c9; }

        /* --- Mobile-Specific Adjustments (Portrait Mode Focus) --- */
        @media (max-width: 768px) { /* General mobile breakpoint */
            .header { 
                padding: 10px 15px; 
                font-size: 1em; 
            }
            .header .user-info { font-size: 0.95em; }
            .header .user-info i { font-size: 1.1em; }
            .header .dm-icon,
            .header .logout-icon { font-size: 1.3em; }

            .main-content { 
                padding: 15px; 
                margin-top: 65px; /* Adjust for smaller header */
                margin-bottom: 60px; /* Adjust for smaller footer */
            }
            .chat-container { 
                padding: 15px; 
                width: 100%; /* Ensure it takes full available width */
                /* Adjusted height: 100vh - (header_height + footer_height + main_top_padding + main_bottom_padding) */
                height: calc(100vh - (65px + 60px + 15px + 15px)); 
                min-height: 350px; /* Adjusted minimum height */
            }
            .chat-container h2 { 
                font-size: 1.5em; 
                margin-bottom: 5px; 
            }
            .recipient-status {
                font-size: 0.8em;
                margin-bottom: 10px;
            }
            .chat-message-area { 
                padding: 10px; 
                gap: 6px; 
            }
            .message-bubble { 
                max-width: 85%; /* Give more space to messages on smaller screens */
                font-size: 0.95em;
            }
            /* NEW: Smaller avatar on mobile */
            .message-avatar, .typing-indicator-avatar {
                width: 25px;
                height: 25px;
                margin-right: 5px;
            }
            /* END NEW */
            .typing-indicator-bubble {
                font-size: 0.85em;
                padding: 6px 10px;
            }
            .typing-indicator-bubble .dot {
                width: 5px;
                height: 5px;
            }
            .chat-input-area input[type="text"] { 
                font-size: 0.9em; 
                padding: 8px 35px 8px 12px; /* Adjusted padding for smaller send icon */
                width: calc(100% - 35px); /* Adjusted width for input box */
            }
            .chat-input-area .send-icon-btn {
                font-size: 1.3em;
                right: 7px;
            }

            .footer { 
                padding: 10px 0; 
            }
            .footer .nav-icon { 
                font-size: 0.7em; 
                padding: 3px;
            }
            .footer .nav-icon i { 
                font-size: 1.3em; 
                margin-bottom: 3px;
            }

            .reactions-row {
                padding: 6px 8px;
            }

            .reactions-row .emoji {
                font-size: 1.3em;
            }
        }

        @media (max-width: 480px) { /* Smaller phones */
            .header { padding: 8px 10px; }
            .header .user-info { font-size: 0.9em; }
            .header .user-info i { font-size: 1em; margin-right: 5px; }
            .header .dm-icon,
            .header .logout-icon { font-size: 1.2em; }

            .main-content { padding: 10px; margin-top: 60px; margin-bottom: 55px; }
            .chat-container { 
                padding: 10px; 
                height: calc(100vh - (60px + 55px + 10px + 10px)); 
                min-height: 300px; 
            }
            .chat-container h2 { font-size: 1.4em; }
            .recipient-status { font-size: 0.75em; margin-bottom: 8px; }
            .chat-message-area { padding: 8px; }
            .message-bubble { font-size: 0.9em; }
            .typing-indicator-bubble {
                font-size: 0.8em;
                padding: 5px 8px;
            }
            .typing-indicator-bubble .dot {
                width: 4px;
                height: 4px;
            }
            /* NEW: Even smaller avatar on very small phones */
            .message-avatar, .typing-indicator-avatar {
                width: 20px;
                height: 20px;
                margin-right: 4px;
            }
            /* END NEW */
            .chat-input-area input[type="text"] { padding: 7px 30px 7px 10px; font-size: 0.85em; }
            .chat-input-area .send-icon-btn {
                font-size: 1.2em;
                right: 5px;
            }

            .footer { padding: 8px 0; }
            .footer .nav-icon { font-size: 0.65em; }
            .footer .nav-icon i { font-size: 1.2em; }

            .reactions-row {
                padding: 5px 8px;
            }
            .reactions-row .emoji {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="user-info">
            <i class="fas fa-user-circle"></i> <span id="usernameDisplay">Loading...</span>
            <span id="headerVerifiedTickContainer"></span>
        </div>
        <div class="user-actions">
            <i class="fas fa-comment-dots dm-icon" id="dmIcon" title="Direct Messages"></i>
            <i class="fas fa-sign-out-alt logout-icon" id="logoutIcon" title="Logout"></i>
        </div>
    </div>

    <div class="main-content">
        <div class="chat-container">
            <h2 id="chatRecipient">
                <span id="recipientUsernameText">Loading...</span> 
                <span id="chatRecipientVerifiedTickContainer"></span>
            </h2>
            <div class="recipient-status" id="recipientStatus">Offline</div>
            <div class="chat-message-area" id="chatMessageArea">
                <div class="message-wrapper" data-message-id="placeholder_received">
                    <div class="message-row received">
                        <img class="message-avatar" src="https://via.placeholder.com/30" alt="Avatar">
                        <p class="message-bubble">
                            <span class="message-sender-in-bubble">Recipient Name</span>
                            <span class="message-content-wrapper">
                                <span class="message-text">Hi there! This is a placeholder chat. Messages will appear here.</span>
                                <span class="message-metadata">
                                    <span class="message-timestamp">10:30 AM</span>
                                </span>
                            </span>
                        </p>
                        <i class="fas fa-ellipsis-h reaction-dots-icon" data-message-id="placeholder_received"></i>
                    </div>
                    <div class="reactions-row" data-message-id="placeholder_received">
                        <span class="emoji" data-emoji="❤">❤</span>
                        <span class="emoji" data-emoji="😭">😭</span>
                        <span class="emoji" data-emoji="😘">😘</span>
                        <span class="emoji" data-emoji="😎">😎</span>
                        <span class="emoji" data-emoji="🙃">🙃</span>
                    </div>
                </div>

                <div class="message-wrapper" data-message-id="placeholder_sent">
                    <div class="message-row sent">
                        <p class="message-bubble">
                            <span class="message-sender-in-bubble">You</span>
                            <span class="message-content-wrapper">
                                <span class="message-text">Got it! Ready for real messages to load.</span>
                                <span class="message-metadata">
                                    <span class="message-timestamp">10:31 AM</span>
                                    <span class="seen-tick"></span>
                                </span>
                            </span>
                        </p>
                        <i class="fas fa-ellipsis-h reaction-dots-icon" data-message-id="placeholder_sent"></i>
                    </div>
                    <div class="reactions-row" data-message-id="placeholder_sent">
                        <span class="emoji" data-emoji="❤">❤</span>
                        <span class="emoji" data-emoji="😭">😭</span>
                        <span class="emoji" data-emoji="😘">😘</span>
                        <span class="emoji" data-emoji="😎">😎</span>
                        <span class="emoji" data-emoji="🙃">🙃</span>
                    </div>
                </div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="Type your message...">
                <button id="sendMessageBtn" class="send-icon-btn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="nav-icon" id="homeIcon">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </div>
        <div class="nav-icon" id="requestsIcon">
            <i class="fas fa-bell"></i>
            <span>Requests</span>
        </div>
        <div class="nav-icon" id="plusIcon">
            <i class="fas fa-plus-circle"></i>
            <span>Add</span>
        </div>
        <div class="nav-icon" id="searchIcon">
            <i class="fas fa-search"></i>
            <span>Search</span>
        </div>
        <div class="nav-icon" id="profileIcon">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Initialize Firebase with your actual config
        const firebaseConfig = {
            apiKey: "AIzaSyB2mV0bya1fD17kQZQeMP11a9mlK-sVEnc",
            authDomain: "citas-bd0a3.firebaseapp.com",
            databaseURL: "https://citas-bd0a3-default-rtdb.firebaseio.com",
            projectId: "citas-bd0a3",
            storageBucket: "citas-bd0a3.firebasestorage.app",
            messagingSenderId: "1082213903517",
            appId: "1:1082213903517:web:22409e051e5442f37ef874",
            measurementId: "G-TXKMGDLMVB"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let currentUsername = "User";

        const usernameDisplay = document.getElementById('usernameDisplay');
        const headerVerifiedTickContainer = document.getElementById('headerVerifiedTickContainer');
        const logoutIcon = document.getElementById('logoutIcon');
        const dmIcon = document.getElementById('dmIcon');

        const recipientUsernameText = document.getElementById('recipientUsernameText');
        const chatRecipientVerifiedTickContainer = document.getElementById('chatRecipientVerifiedTickContainer');
        const recipientStatus = document.getElementById('recipientStatus');
        const chatMessageArea = document.getElementById('chatMessageArea');
        const chatInput = document.getElementById('chatInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');

        let recipientUserId = null;
        let recipientUsername = null;
        let recipientAvatar = null; // NEW: To store recipient's avatar URL
        let recipientIsTyping = false;
        let recipientLastSeen = 'Unknown'; // Will be updated by data
        let recipientIsOnline = false; // New state to track if recipient is online

        // Store the typing indicator element so we can easily add/remove it
        let typingIndicatorElement = null;

        // Bottom Navigation Icons
        const homeIcon = document.getElementById('homeIcon');
        const requestsIcon = document.getElementById('requestsIcon');
        const plusIcon = document.getElementById('plusIcon');
        const searchIcon = document.getElementById('searchIcon');
        const profileIcon = document.getElementById('profileIcon');

        // SVG for the green ticks
        const verifiedTickSvgHeader = `
            <svg class="verified-tick-header" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/>
            </svg>
        `;
        const verifiedTickSvgChat = `
            <svg class="verified-tick-chat" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/>
            </svg>
        `;
        // Single tick for 'delivered' (or default)
        const singleTickSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path d="M470.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L224 306.7 425.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/>
            </svg>
        `;
        // Double tick for 'seen' - improved SVG
        const redTickSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="width: 20px; height: 12px; transform: scale(0.8); fill: #F44336;">
                <path d="M470.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L224 306.7 425.4 105.4c12.5-12.5 32.8-12.5 45.3 0z" />
                <path d="M470.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L224 306.7 425.4 105.4c12.5-12.5 32.8-12.5 45.3 0z" transform="translate(10, 0)" />
            </svg>
        `;
        // SVG for the online dot
        const onlineDotSvg = `
            <svg class="online-dot" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <circle cx="256" cy="256" r="256"/>
            </svg>
        `;

        const REACTION_EMOJIS = ['❤', '😭', '😘', '😎', '🙃'];

        // --- Logout Functionality ---
        logoutIcon.addEventListener('click', async () => {
            try {
                // Set current user offline before logging out
                if (currentUser) {
                    await updateUserStatus(currentUser.uid, 'offline');
                }
                await auth.signOut();
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Error signing out:", error.message);
                alert("Error logging out. Please try again.");
            }
        });

        // --- DM Icon Functionality ---
        dmIcon.addEventListener('click', () => {
            window.location.href = 'dm.html'; // Go back to the DM list
        });

        // --- Auth State Observer ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                console.log("User is logged in:", user.email, "UID:", user.uid);
                await loadHeaderUserInfo(currentUser.uid);
                parseUrlParameters(); 

                if (recipientUserId) {
                    // Load recipient info and set up all real-time listeners
                    await loadRecipientInfo(recipientUserId); 
                    setupRealtimeChatListeners(currentUser.uid, recipientUserId);
                    setupTypingInputListener(currentUser.uid, recipientUserId); // Renamed for clarity
                    updateUserStatus(currentUser.uid, 'online'); // Set current user online when active in chat
                    setupReactionClickListeners(); // Setup reaction click listeners
                } else {
                    recipientUsernameText.textContent = "Invalid Chat";
                    chatRecipientVerifiedTickContainer.innerHTML = '';
                    chatInput.disabled = true;
                    sendMessageBtn.disabled = true;
                    recipientStatus.textContent = '';
                    chatMessageArea.innerHTML = "<div class='message-wrapper'><div class='message-row received'><p class='message-bubble'><span class='message-content-wrapper'><span class='message-text'>No chat recipient specified. Please go back to DMs to select a user.</span><span class='message-metadata'><span class='message-timestamp'></span></span></span></p></div></div>";
                }

            } else {
                console.log("No user logged in. Redirecting to index.html");
                window.location.href = 'index.html';
            }
        });

        // Add an unload event to set user offline
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                // Ensure status is set to offline when leaving the page
                updateUserStatus(currentUser.uid, 'offline');
            }
        });

        // --- Load Header User Info (Username, Verification) ---
        async function loadHeaderUserInfo(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    currentUsername = userData.username || "User";
                    usernameDisplay.textContent = currentUsername;

                    if (userData.isVerified) {
                        headerVerifiedTickContainer.innerHTML = verifiedTickSvgHeader;
                    } else {
                        headerVerifiedTickContainer.innerHTML = '';
                    }
                } else {
                    usernameDisplay.textContent = "User";
                    headerVerifiedTickContainer.innerHTML = '';
                    console.error("User document not found for header:", userId);
                }
            } catch (error) {
                console.error("Error loading header user info:", error);
                usernameDisplay.textContent = "Error";
            }
        }

        // --- Parse URL Parameters for Chat Recipient ---
        function parseUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            recipientUserId = urlParams.get('userId');
            recipientUsername = decodeURIComponent(urlParams.get('username') || 'Unknown User');
            // NEW: Get avatar from URL param if available (though fetching from Firestore is more reliable)
            recipientAvatar = decodeURIComponent(urlParams.get('avatar') || ''); 
            console.log("Attempting to chat with:", recipientUsername, "ID:", recipientUserId, "Avatar:", recipientAvatar);
            recipientUsernameText.textContent = recipientUsername; // Set initial name
        }

        // --- Load Recipient's Info (Verification Status, Online Status, Last Seen, Avatar) ---
        async function loadRecipientInfo(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    const isVerified = userData.isVerified || false;
                    const status = userData.status || 'offline'; // Default to offline
                    recipientAvatar = userData.avatar || ''; // NEW: Get recipient's avatar from Firestore
                    
                    let lastSeenFormatted = 'Never';
                    if (userData.lastSeen && userData.lastSeen instanceof firebase.firestore.Timestamp) {
                        const lastSeenDate = userData.lastSeen.toDate();
                        lastSeenFormatted = lastSeenDate.toLocaleString('en-IN', {
                            hour: '2-digit', 
                            minute: '2-digit', 
                            hour12: true, 
                            day: 'numeric', 
                            month: 'short' 
                        });
                    } else if (typeof userData.lastSeen === 'string') {
                        const lastSeenDate = new Date(userData.lastSeen);
                        if (!isNaN(lastSeenDate)) {
                             lastSeenFormatted = lastSeenDate.toLocaleString('en-IN', {
                                hour: '2-digit', 
                                minute: '2-digit', 
                                hour12: true, 
                                day: 'numeric', 
                                month: 'short' 
                            });
                        }
                    }

                    recipientLastSeen = lastSeenFormatted; // Update stored last seen
                    recipientIsOnline = (status === 'online'); // Update online status

                    if (isVerified) {
                        chatRecipientVerifiedTickContainer.innerHTML = verifiedTickSvgChat;
                    } else {
                        chatRecipientVerifiedTickContainer.innerHTML = '';
                    }
                    updateRecipientStatusDisplay(); // Call without arguments, it will use stored values
                } else {
                    console.warn("Recipient user document not found:", userId);
                    chatRecipientVerifiedTickContainer.innerHTML = ''; // No tick if user not found
                    recipientIsOnline = false;
                    recipientLastSeen = 'Unknown';
                    recipientAvatar = null; // NEW: Reset avatar if user not found
                    updateRecipientStatusDisplay();
                }
            } catch (error) {
                console.error("Error loading recipient info:", error);
                chatRecipientVerifiedTickContainer.innerHTML = '';
                recipientIsOnline = false;
                recipientLastSeen = 'Error';
                recipientAvatar = null; // NEW: Reset avatar on error
                updateRecipientStatusDisplay();
            }
        }

        // --- Update User Status (Online/Offline) ---
        async function updateUserStatus(userId, status) {
            try {
                // Only update if current user is defined
                if (userId) {
                    await db.collection('users').doc(userId).update({
                        status: status,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp() 
                    });
                    console.log(`User ${userId} status updated to: ${status}`);
                }
            } catch (error) {
                console.error("Error updating user status:", error);
            }
        }

        // --- Update Recipient Status Display (Only Online/Last Seen) ---
        function updateRecipientStatusDisplay() {
            if (recipientIsOnline) {
                recipientStatus.innerHTML = `Online ${onlineDotSvg}`; // Show online with dot
                recipientStatus.style.color = '#4CAF50';
            } else {
                recipientStatus.textContent = `Last seen: ${recipientLastSeen}`;
                recipientStatus.style.color = '#777';
            }
        }

        // --- Setup Realtime Chat Listeners ---
        function setupRealtimeChatListeners(senderId, receiverId) {
            const chatRoomId = [senderId, receiverId].sort().join('_');
            
            // Listen for new messages and message updates
            db.collection('chats').doc(chatRoomId).collection('messages')
                .orderBy('timestamp')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        const message = { ...change.doc.data(), id: change.doc.id }; // Include doc ID

                        if (change.type === 'added') {
                            displayMessage(message);
                        } else if (change.type === 'modified') {
                            const messageWrapper = document.querySelector(`.message-wrapper[data-message-id="${message.id}"]`);
                            if (messageWrapper) {
                                // If it's a message sent by the current user and it's now seen
                                if (message.senderId === currentUser.uid && message.seen) {
                                    messageWrapper.querySelector('.message-bubble').classList.add('seen');
                                    const seenTickElement = messageWrapper.querySelector('.seen-tick');
                                    if (seenTickElement) {
                                        seenTickElement.innerHTML = redTickSvg;
                                    }
                                }
                                // Update reactions if they changed
                                updateMessageReactions(message);
                            }
                        } else if (change.type === 'removed') {
                            const messageWrapper = document.querySelector(`.message-wrapper[data-message-id="${message.id}"]`);
                            if (messageWrapper) {
                                messageWrapper.remove();
                            }
                        }
                    });
                    chatMessageArea.scrollTop = chatMessageArea.scrollHeight; // Scroll to bottom
                    markMessagesAsSeen(currentUser.uid, recipientUserId); 
                }, error => {
                    console.error("Error listening to messages:", error);
                });

            // LISTEN FOR RECIPIENT'S ONLINE STATUS AND LAST SEEN
            db.collection('users').doc(receiverId).onSnapshot(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    const status = userData.status || 'offline';
                    recipientAvatar = userData.avatar || ''; // NEW: Update recipient avatar in real-time
                    
                    let lastSeenFormatted = 'Never';

                    if (userData.lastSeen && userData.lastSeen instanceof firebase.firestore.Timestamp) {
                        const lastSeenDate = userData.lastSeen.toDate();
                        lastSeenFormatted = lastSeenDate.toLocaleString('en-IN', {
                            hour: '2-digit', 
                            minute: '2-digit', 
                            hour12: true, 
                            day: 'numeric', 
                            month: 'short' 
                        });
                    } else if (typeof userData.lastSeen === 'string') {
                        const lastSeenDate = new Date(userData.lastSeen);
                        if (!isNaN(lastSeenDate)) {
                             lastSeenFormatted = lastSeenDate.toLocaleString('en-IN', {
                                hour: '2-digit', 
                                minute: '2-digit', 
                                hour12: true, 
                                day: 'numeric', 
                                month: 'short' 
                            });
                        }
                    }

                    recipientLastSeen = lastSeenFormatted; // Update stored last seen
                    recipientIsOnline = (status === 'online'); // Update online status
                    updateRecipientStatusDisplay(); // Update display based on current online status
                } else {
                    recipientIsOnline = false;
                    recipientLastSeen = 'Unknown User';
                    recipientAvatar = null; // NEW: Reset avatar if user no longer exists or doc removed
                    updateRecipientStatusDisplay();
                }
            }, error => {
                console.error("Error listening to recipient status:", error);
            });


            // Typing status listener
            db.collection('typingStatus').doc(chatRoomId)
                .onSnapshot(doc => {
                    if (doc.exists) {
                        const typingData = doc.data();
                        // Check if the *recipient* (receiverId) is typing
                        recipientIsTyping = typingData && typingData[receiverId]; 
                        
                        if (recipientIsTyping) {
                            displayTypingIndicator();
                        } else {
                            removeTypingIndicator();
                        }
                    } else {
                        recipientIsTyping = false;
                        removeTypingIndicator();
                    }
                }, error => {
                    console.error("Error listening to typing status:", error);
                });
        }

        // --- Display Typing Indicator in Chat Area ---
        function displayTypingIndicator() {
            if (typingIndicatorElement) {
                // If already exists, make sure it's visible and at the bottom
                typingIndicatorElement.style.display = 'flex';
                chatMessageArea.scrollTop = chatMessageArea.scrollHeight;
                return;
            }

            // Create a temporary message row for the typing indicator to align it correctly
            const typingIndicatorRow = document.createElement('div');
            typingIndicatorRow.classList.add('message-row', 'received'); // Use received class for alignment

            if (recipientAvatar) {
                const avatarImg = document.createElement('img');
                avatarImg.classList.add('message-avatar', 'typing-indicator-avatar');
                avatarImg.src = recipientAvatar;
                avatarImg.alt = "Avatar";
                typingIndicatorRow.appendChild(avatarImg);
            }

            typingIndicatorElement = document.createElement('p');
            typingIndicatorElement.classList.add('typing-indicator-bubble');
            typingIndicatorElement.id = 'typingIndicator';
            typingIndicatorElement.innerHTML = `
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            `;
            
            typingIndicatorRow.appendChild(typingIndicatorElement);
            chatMessageArea.appendChild(typingIndicatorRow);
            chatMessageArea.scrollTop = chatMessageArea.scrollHeight; // Scroll to bottom
        }

        // --- Remove Typing Indicator from Chat Area ---
        function removeTypingIndicator() {
            if (typingIndicatorElement && typingIndicatorElement.parentNode) {
                // Remove the parent message-row if it exists
                const typingIndicatorRow = typingIndicatorElement.closest('.message-row');
                if (typingIndicatorRow) {
                    typingIndicatorRow.remove();
                }
                typingIndicatorElement = null; // Clear reference
            }
        }

        // --- Display Message in Chat Area ---
        function displayMessage(message) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('message-wrapper');
            messageWrapper.setAttribute('data-message-id', message.id);
            
            const messageRow = document.createElement('div');
            messageRow.classList.add('message-row'); 

            const messageBubble = document.createElement('p');
            messageBubble.classList.add('message-bubble');

            // Use 'HH:MM AM/PM' format
            const timestamp = message.timestamp ? new Date(message.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }) : '';
            
            let tickHtml = '';
            let senderNameInBubble = '';

            const reactionDotsIcon = document.createElement('i');
            reactionDotsIcon.classList.add('fas', 'fa-ellipsis-h', 'reaction-dots-icon');
            reactionDotsIcon.setAttribute('data-message-id', message.id);

            const reactionsRow = document.createElement('div');
            reactionsRow.classList.add('reactions-row');
            reactionsRow.setAttribute('data-message-id', message.id);
            REACTION_EMOJIS.forEach(emoji => {
                reactionsRow.innerHTML += `<span class="emoji" data-emoji="${emoji}">${emoji}</span>`;
            });

            if (message.senderId === currentUser.uid) {
                messageRow.classList.add('sent');
                senderNameInBubble = '<span class="message-sender-in-bubble">You</span>';
                tickHtml = message.seen ? redTickSvg : singleTickSvg; 
                
                // For sent messages, the avatar is not displayed in the chat bubble itself,
                // but the message bubble and dots are aligned.
                messageRow.appendChild(messageBubble); // Bubble first
                messageRow.appendChild(reactionDotsIcon); // Dots icon on the right
            } else {
                messageRow.classList.add('received');
                senderNameInBubble = `<span class="message-sender-in-bubble">${recipientUsername}</span>`;
                
                // NEW: Add avatar for received messages
                if (recipientAvatar) {
                    const avatarImg = document.createElement('img');
                    avatarImg.classList.add('message-avatar');
                    avatarImg.src = recipientAvatar;
                    avatarImg.alt = "Avatar";
                    messageRow.prepend(avatarImg); // Prepend avatar to the message row
                } else {
                    // Fallback avatar if recipientAvatar is empty
                    const fallbackAvatarImg = document.createElement('img');
                    fallbackAvatarImg.classList.add('message-avatar');
                    fallbackAvatarImg.src = "https://via.placeholder.com/30"; // Placeholder URL
                    fallbackAvatarImg.alt = "Avatar";
                    messageRow.prepend(fallbackAvatarImg);
                }
                // END NEW

                messageRow.appendChild(messageBubble); // Bubble first
                messageRow.appendChild(reactionDotsIcon); // Dots icon on the right
            }

            messageBubble.innerHTML = `
                ${senderNameInBubble}
                <span class="message-content-wrapper">
                    <span class="message-text">${message.text}</span>
                    <span class="message-metadata">
                        <span class="message-timestamp">${timestamp}</span>
                        ${message.senderId === currentUser.uid ? `<span class="seen-tick">${tickHtml}</span>` : ''}
                    </span>
                </span>
            `;
            
            messageWrapper.appendChild(messageRow);
            messageWrapper.appendChild(reactionsRow); // Add the hidden reactions row

            // Append reaction summary if reactions exist
            if (message.reactions && Object.keys(message.reactions).length > 0) {
                const reactionsSummaryContainer = document.createElement('div');
                reactionsSummaryContainer.classList.add('message-reactions');
                for (const emoji in message.reactions) {
                    const count = Object.keys(message.reactions[emoji]).length;
                    reactionsSummaryContainer.innerHTML += `<span class="reaction-item"><span class="reaction-emoji">${emoji}</span><span class="reaction-count">${count}</span></span>`;
                }
                messageWrapper.appendChild(reactionsSummaryContainer);
            }

            chatMessageArea.appendChild(messageWrapper);

            if (message.senderId === currentUser.uid && message.seen) {
                messageBubble.classList.add('seen'); 
            }
        }

        // Function to update reactions on an existing message bubble
        function updateMessageReactions(message) {
            const messageWrapper = document.querySelector(`.message-wrapper[data-message-id="${message.id}"]`);
            if (!messageWrapper) return;

            let reactionsSummaryContainer = messageWrapper.querySelector('.message-reactions');

            if (message.reactions && Object.keys(message.reactions).length > 0) {
                if (!reactionsSummaryContainer) {
                    reactionsSummaryContainer = document.createElement('div');
                    reactionsSummaryContainer.classList.add('message-reactions');
                    messageWrapper.appendChild(reactionsSummaryContainer);
                }
                reactionsSummaryContainer.innerHTML = ''; // Clear existing reactions
                for (const emoji in message.reactions) {
                    const count = Object.keys(message.reactions[emoji]).length;
                    reactionsSummaryContainer.innerHTML += `<span class="reaction-item"><span class="reaction-emoji">${emoji}</span><span class="reaction-count">${count}</span></span>`;
                }
            } else {
                if (reactionsSummaryContainer) {
                    reactionsSummaryContainer.remove(); // Remove container if no reactions
                }
            }
        }

        // --- Mark Messages as Seen ---
        async function markMessagesAsSeen(currentUserId, chatPartnerId) {
            if (!currentUserId || !chatPartnerId) return; // Ensure IDs are present
            const chatRoomId = [currentUserId, chatPartnerId].sort().join('_');
            const messagesRef = db.collection('chats').doc(chatRoomId).collection('messages');

            try {
                // Get messages that are *sent by the chat partner* and *not yet seen by the current user*
                const unseenMessagesSnapshot = await messagesRef
                    .where('senderId', '==', chatPartnerId) 
                    .where('receiverId', '==', currentUserId) 
                    .where('seen', '==', false)
                    .get();

                if (unseenMessagesSnapshot.empty) {
                    return Promise.resolve();
                }

                const batch = db.batch();
                unseenMessagesSnapshot.forEach(doc => {
                    batch.update(doc.ref, { seen: true });
                });
                await batch.commit();
                console.log(`Marked ${unseenMessagesSnapshot.size} messages as seen.`);
            } catch (error) {
                console.error("Error marking messages as seen:", error);
            }
        }


        // --- Send Message Function ---
        sendMessageBtn.addEventListener('click', async () => {
            const messageText = chatInput.value.trim();
            if (messageText && currentUser && recipientUserId) {
                const chatRoomId = [currentUser.uid, recipientUserId].sort().join('_'); 

                try {
                    const docRef = await db.collection('chats').doc(chatRoomId).collection('messages').add({
                        senderId: currentUser.uid,
                        receiverId: recipientUserId,
                        text: messageText,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(), 
                        seen: false,
                        reactions: {} // Initialize reactions as an empty object
                    });
                    console.log("Message sent to Firestore with ID:", docRef.id);
                    chatInput.value = ''; // Clear the input box after sending
                    updateTypingStatus(false); // Set typing status to false after sending
                } catch (error) {
                    console.error("Error sending message:", error);
                    alert("Failed to send message.");
                }
            } else {
                alert("Please type a message and ensure a recipient is selected.");
            }
        });

        // Optional: Send message on Enter key press
        chatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); 
                sendMessageBtn.click();
            }
        });

        // --- Typing Indicator Logic ---
        let typingTimeout;
        const TYPING_TIMEOUT_DURATION = 3000; // 3 seconds

        function setupTypingInputListener() {
            chatInput.addEventListener('input', () => {
                if (!currentUser || !recipientUserId) return;
                updateTypingStatus(true); // User is typing

                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    updateTypingStatus(false); // User stopped typing
                }, TYPING_TIMEOUT_DURATION);
            });
        }

        async function updateTypingStatus(isTyping) {
            if (!currentUser || !recipientUserId) return;
            const chatRoomId = [currentUser.uid, recipientUserId].sort().join('_');
            const typingDocRef = db.collection('typingStatus').doc(chatRoomId);

            try {
                await typingDocRef.set({
                    [currentUser.uid]: isTyping
                }, { merge: true }); 
                console.log(`Typing status for ${currentUser.uid} set to: ${isTyping}`);
            } catch (error) {
                console.error("Error updating typing status:", error);
            }
        }

        // --- Reaction Logic ---
        let currentOpenReactionsRow = null; // Track which reactions-row is currently open

        function setupReactionClickListeners() {
            chatMessageArea.addEventListener('click', (event) => {
                const dotsIcon = event.target.closest('.reaction-dots-icon');
                if (dotsIcon) {
                    const messageId = dotsIcon.getAttribute('data-message-id');
                    toggleReactionsRow(messageId);
                } else {
                    // If click is outside any dots icon, hide any open reactions row
                    hideAllReactionsRows();
                }
            });

            // Delegate emoji click handling to the chatMessageArea
            chatMessageArea.addEventListener('click', async (event) => {
                const emojiElement = event.target.closest('.reactions-row .emoji');
                if (emojiElement) {
                    const emoji = emojiElement.getAttribute('data-emoji');
                    const reactionsRow = emojiElement.closest('.reactions-row');
                    const messageId = reactionsRow.getAttribute('data-message-id');

                    if (emoji && messageId && currentUser && recipientUserId) {
                        console.log(`Reacting to message ${messageId} with emoji: ${emoji}`);
                        await addReactionToMessage(messageId, emoji, currentUser.uid);
                        hideAllReactionsRows(); // Hide after reacting
                    }
                }
            });
        }

        function toggleReactionsRow(messageId) {
            const targetReactionsRow = document.querySelector(`.reactions-row[data-message-id="${messageId}"]`);
            if (!targetReactionsRow) return;

            if (currentOpenReactionsRow && currentOpenReactionsRow !== targetReactionsRow) {
                // Hide previously open row
                currentOpenReactionsRow.classList.remove('visible');
            }

            // Toggle visibility of the target row
            targetReactionsRow.classList.toggle('visible');

            if (targetReactionsRow.classList.contains('visible')) {
                currentOpenReactionsRow = targetReactionsRow;
                // Scroll to bottom after opening reactions row if it causes overflow
                chatMessageArea.scrollTop = chatMessageArea.scrollHeight;
            } else {
                currentOpenReactionsRow = null;
            }
        }

        function hideAllReactionsRows() {
            if (currentOpenReactionsRow) {
                currentOpenReactionsRow.classList.remove('visible');
                currentOpenReactionsRow = null;
            }
        }

        async function addReactionToMessage(messageId, emoji, userId) {
            if (!currentUser || !recipientUserId) return;
            const chatRoomId = [currentUser.uid, recipientUserId].sort().join('_');
            const messageRef = db.collection('chats').doc(chatRoomId).collection('messages').doc(messageId);

            try {
                await db.runTransaction(async (transaction) => {
                    const messageDoc = await transaction.get(messageRef);
                    if (!messageDoc.exists) {
                        throw "Message document does not exist!";
                    }

                    const currentReactions = messageDoc.data().reactions || {};
                    const hasReacted = currentReactions[emoji] && currentReactions[emoji][userId];

                    let newReactions = { ...currentReactions };

                    if (hasReacted) {
                        // User already reacted with this emoji, remove their reaction
                        delete newReactions[emoji][userId];
                        if (Object.keys(newReactions[emoji]).length === 0) {
                            delete newReactions[emoji];
                        }
                    } else {
                        // Add or update the reaction for this user
                        if (!newReactions[emoji]) {
                            newReactions[emoji] = {};
                        }
                        newReactions[emoji][userId] = true;
                    }
                    
                    transaction.update(messageRef, { reactions: newReactions });
                });
                console.log("Reaction updated successfully!");
            } catch (error) {
                console.error("Error updating reaction:", error);
            }
        }


        // --- Bottom Nav Icon Click Handlers ---
        homeIcon.addEventListener('click', () => {
            window.location.href = 'home.html';
        });
        requestsIcon.addEventListener('click', () => {
            window.location.href = 'requests.html';
        });
        plusIcon.addEventListener('click', () => {
            window.location.href = 'post.html';
        });
        searchIcon.addEventListener('click', () => {
            window.location.href = 'search.html';
        });
        profileIcon.addEventListener('click', () => {
            window.location.href = 'profile.html';
        });

        // Set the active icon on page load based on current page
        document.addEventListener('DOMContentLoaded', () => {
            const path = window.location.pathname.split('/').pop();
        });

        function updateActiveNavIcon(clickedIcon) {
            const allNavIcons = document.querySelectorAll('.footer .nav-icon');
            allNavIcons.forEach(icon => {
                icon.classList.remove('active');
            });
            if (clickedIcon.closest('.footer')) {
                clickedIcon.classList.add('active');
            }
        }
    </script>
</body>
</html>