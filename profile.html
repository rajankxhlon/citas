<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Top Header Bar */
        .header {
            width: 100%;
            background: linear-gradient(to right, #4CAF50, #66BB6A);
            padding: 15px 20px;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 20;
            box-sizing: border-box;
        }
        .header .user-info { display: flex; align-items: center; font-size: 1.1em; font-weight: 500; }
        .header .user-info i { margin-right: 10px; font-size: 1.3em; }

        /* Container for DM and Settings icons */
        .header .user-actions {
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        /* DM and Settings icon style */
        .header .dm-icon,
        .header .settings-icon {
            color: #fff;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        .header .dm-icon:hover,
        .header .settings-icon:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Style for the verified tick in header (matching comments.html & search.html) */
        .header .verified-tick-header {
            width: 14px;
            height: 14px;
            vertical-align: middle;
            margin-left: 3px;
            fill: #fff;
        }

        /* Main Content Area */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            margin-top: 80px;
            margin-bottom: 70px;
            box-sizing: border-box;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .profile-card {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        .profile-picture {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #00BCD4;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3em;
            font-weight: bold;
            margin: 0 auto 20px auto;
            border: 3px solid #00ACC1;
            position: relative;
            overflow: hidden;
        }

        .profile-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            display: block;
        }

        /* Pencil icon for profile picture edit */
        .profile-picture .edit-icon {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.6);
            color: #fff;
            border-radius: 50%;
            padding: 8px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .profile-picture .edit-icon:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }

        /* Avatar selection popup (now also used for initial choice) */
        .avatar-modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .avatar-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 450px;
            text-align: center;
            position: relative;
        }

        .avatar-modal-content h3 {
            margin-top: 0;
            color: #4CAF50;
        }

        .avatar-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .avatar-option {
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #eee;
            transition: border-color 0.3s ease;
        }

        .avatar-option.selected {
            border-color: #4CAF50;
        }

        .avatar-option img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
        }

        .avatar-modal-actions {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .avatar-modal-actions button {
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
        }

        .avatar-modal-actions .save-avatar-btn {
            background-color: #4CAF50;
            color: #fff;
        }
        .avatar-modal-actions .save-avatar-btn:hover {
            background-color: #45a049;
        }

        .avatar-modal-actions .cancel-avatar-btn {
            background-color: #f44336;
            color: #fff;
        }
        .avatar-modal-actions .cancel-avatar-btn:hover {
            background-color: #da190b;
        }


        .profile-username {
            font-size: 1.8em;
            font-weight: 700;
            color: #4CAF50;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .profile-bio {
            font-size: 1em;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 0 10px;
            text-align: center;
            position: relative;
        }

        .profile-bio.editing {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .profile-bio-textarea {
            width: calc(100% - 20px);
            min-height: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            font-family: 'Roboto', sans-serif;
            font-size: 1em;
            box-sizing: border-box;
        }

        .bio-edit-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-top: 5px;
        }

        .bio-edit-controls button {
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
        }

        .bio-edit-controls .save-btn {
            background-color: #4CAF50;
            color: #fff;
            border: none;
        }
        .bio-edit-controls .save-btn:hover {
            background-color: #45a049;
        }
        .bio-edit-controls .cancel-btn {
            background-color: #f44336;
            color: #fff;
            border: none;
        }
        .bio-edit-controls .cancel-btn:hover {
            background-color: #da190b;
        }

        /* Edit icon for bio */
        .bio-edit-icon {
            position: absolute;
            top: 0px;
            right: 0px;
            cursor: pointer;
            color: #888;
            font-size: 0.9em;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .bio-edit-icon:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }


        .profile-stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .profile-stats .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 1em;
            color: #555;
        }
        .profile-stats .stat-value {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .profile-posts-section {
            width: 100%;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            text-align: left;
            margin-top: 20px; /* Added margin to separate from profile card */
        }

        .profile-posts-section h2 {
            color: #4CAF50;
            font-size: 1.8em;
            margin-bottom: 20px;
            text-align: center;
        }

        .post-item {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            margin-bottom: 15px;
            position: relative;
        }

        .post-item .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 500;
            color: #555;
            justify-content: space-between;
        }
        .post-item .post-header .user-info-in-post { /* NEW: Flex container for avatar and username */
            display: flex;
            align-items: center;
            gap: 10px; /* Space between avatar and username */
        }
        .post-item .post-header .user-avatar-in-post { /* NEW: Avatar styling in post header */
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #00BCD4; /* Default background */
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            font-weight: bold;
            overflow: hidden;
            flex-shrink: 0; /* Prevent shrinking */
        }
        .post-item .post-header .user-avatar-in-post img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .post-item .post-header .username-display { /* Original username display, now inside user-info-in-post */
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #333;
        }

        /* Verified tick specifically for post cards */
        .post-item .verified-tick-post {
            width: 13px; /* Slightly smaller than header tick */
            height: 13px;
            vertical-align: middle;
            margin-left: 4px; /* Space from username */
            fill: #4CAF50; /* Green color */
            flex-shrink: 0; /* Prevent it from shrinking */
        }

        .post-item .post-content {
            font-size: 1em;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-bottom: 10px;
        }

        /* NEW: Styles for post images */
        .post-item .post-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 15px;
            display: block; /* Ensures image takes its own line */
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Style for editable textarea */
        .post-item .post-content.editing {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            font-family: 'Roboto', sans-serif;
            font-size: 1em;
            box-sizing: border-box;
        }

        .post-item .post-actions {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            align-items: center;
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        .post-item .post-actions button {
            background: none;
            border: none;
            color: #777;
            font-size: 0.9em;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 5px;
            transition: background-color 0.3s ease, color 0.3s ease;
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }
        .post-item .post-actions button i {
            margin-right: 5px;
        }
        .post-item .post-actions button:hover {
            background-color: #e0e0e0;
            color: #333;
        }
        .post-item .post-actions button.liked {
            color: #E91E63;
        }
        /* Style for comment count when it's 0 to hide it */
        .post-item .post-actions button.comment-btn span:empty {
            display: none;
        }
        .no-posts {
            color: #777;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        /* Timestamp at the bottom of the post */
        .post-item .post-time-bottom {
            font-size: 0.8em;
            color: #888;
            margin-top: 8px;
            text-align: right;
            width: 100%;
            padding-right: 5px;
            box-sizing: border-box;
        }

        /* --- Three-dot menu styles --- */
        .post-options-menu {
            position: relative;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            margin-left: auto;
        }

        .post-options-menu:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .post-options-menu svg {
            width: 20px;
            height: 20px;
            fill: #777;
        }

        /* Generic Dropdown for Posts and Settings */
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #fff;
            min-width: 120px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 10;
            border-radius: 5px;
            overflow: hidden;
        }

        /* Specific positioning for post dropdown */
        .post-options-menu .dropdown-content {
            right: 0;
            top: 100%;
            transform: translateY(5px);
        }

        /* Specific positioning for settings dropdown */
        .settings-dropdown-content {
            right: 0;
            top: calc(100% + 10px);
            min-width: 180px;
        }

        .dropdown-content button {
            color: black;
            padding: 10px 15px;
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #eee;
        }
        .dropdown-content button:last-child {
            border-bottom: none;
        }

        .dropdown-content button:hover {
            background-color: #f1f1f1;
        }

        .dropdown-content.show {
            display: block;
        }

        /* Edit/Save/Cancel button styles */
        .edit-controls {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
        .edit-controls button {
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .edit-controls .save-btn {
            background-color: #4CAF50;
            color: #fff;
            border: none;
        }
        .edit-controls .save-btn:hover {
            background-color: #45a049;
        }
        .edit-controls .cancel-btn {
            background-color: #f44336;
            color: #fff;
            border: none;
        }
        .edit-controls .cancel-btn:hover {
            background-color: #da190b;
        }

        /* Bottom Navigation Bar */
        .footer {
            width: 100%;
            background: linear-gradient(to right, #4CAF50, #66BB6A);
            padding: 15px 0;
            color: #fff;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2);
            position: fixed;
            bottom: 0;
            left: 0;
            z-index: 20;
            box-sizing: border-box;
        }
        .footer .nav-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #fff;
            font-size: 0.8em;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .footer .nav-icon i { font-size: 1.5em; margin-bottom: 5px; }
        .footer .nav-icon:hover { background-color: rgba(255, 255, 255, 0.2); }
        .footer .nav-icon.active { color: #c8e6c9; }

        /* Verified tick SVG styling (consistent with comments.html & search.html) */
        .verified-tick {
            width: 12px;
            height: 12px;
            vertical-align: middle;
            margin-left: 2px;
            fill: #4CAF50;
        }

        /* Message pop-up (for verification request feedback) */
        .info-message {
            position: fixed;
            top: 75px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 0.9em;
            z-index: 30;
            display: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            text-align: center;
            white-space: nowrap;
            max-width: 90%;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .info-message.show {
            opacity: 1;
            display: block;
        }
        .info-message.error {
            background-color: #f44336;
        }


        /* Responsive adjustments for smaller screens */
        @media (max-width: 600px) {
            body { padding-top: 70px; padding-bottom: 60px; }
            .header { padding: 10px 15px; font-size: 1em; }
            .header .user-info { font-size: 0.95em; }
            .header .user-info i { font-size: 1.1em; }
            .header .dm-icon,
            .header .settings-icon { font-size: 1.3em; }

            .main-content { padding: 15px; }
            .profile-card { padding: 20px; }
            .profile-picture {
                width: 80px;
                height: 80px;
                font-size: 2.5em;
                margin-bottom: 15px;
            }
            .profile-picture .edit-icon {
                padding: 6px;
                font-size: 0.7em;
            }
            .avatar-modal-content {
                width: 95%;
                padding: 15px;
            }
            .avatar-options {
                gap: 10px;
            }
            .avatar-option img {
                width: 60px;
                height: 60px;
            }
            .profile-username { font-size: 1.5em; }
            .profile-bio { font-size: 0.9em; padding: 0 5px; }
            .profile-bio-textarea { width: calc(100% - 10px); }
            .bio-edit-icon { top: -5px; right: 0px; font-size: 0.8em;}
            .profile-stats { margin-top: 15px; padding-top: 10px; }
            .profile-stats .stat-item { font-size: 0.9em; }
            .profile-stats .stat-value { font-size: 1.1em; }

            .profile-posts-section { padding: 15px; }
            .profile-posts-section h2 { font-size: 1.5em; margin-bottom: 15px; }
            .post-item { padding: 12px; margin-bottom: 10px; }
            .post-item .post-header .user-avatar-in-post { /* NEW: Smaller avatar in post header for mobile */
                width: 30px;
                height: 30px;
                font-size: 1em;
            }
            .post-item .post-header .username-display { /* NEW: Smaller username text for mobile */
                font-size: 0.9em;
            }
            .post-item .verified-tick-post { /* Smaller verified tick for mobile */
                width: 10px;
                height: 10px;
                margin-left: 2px;
            }
            .post-item .post-content { font-size: 0.95em; }
            .post-item .post-actions button { font-size: 0.8em; padding: 6px 8px; }
            .post-options-menu { top: 5px; right: 5px; width: 25px; height: 25px; }
            .post-options-menu svg { width: 18px; height: 18px; }
            .dropdown-content { min-width: 100px; right: 5px; top: 35px; }
            .dropdown-content button { padding: 8px 10px; font-size: 0.8em; }

            .settings-dropdown-content {
                min-width: 160px;
                right: 0;
                top: calc(100% + 5px);
            }

            .footer { padding: 10px 0; }
            .footer .nav-icon { font-size: 0.7em; }
            .footer .nav-icon i { font-size: 1.3em; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="user-info">
            <i class="fas fa-user-circle"></i> <span id="usernameDisplay">Loading...</span>
            <span id="headerVerifiedTickContainer"></span>
        </div>
        <div class="user-actions">
            <i class="fas fa-comment-dots dm-icon" id="dmIcon" title="Direct Messages"></i>
            <i class="fas fa-cog settings-icon" id="settingsIcon" title="Settings"></i>
            <div class="dropdown-content settings-dropdown-content" id="settingsDropdown">
                <button id="requestVerificationBtn">Request for Verification</button>
                <button id="accountInfoBtn">Account Information</button>
                <button id="logoutBtn">Logout</button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="profile-card">
            <div class="profile-picture" id="profilePicture">
                </div>
            <div class="profile-username">
                <span id="profileUsername">Loading...</span>
                <span id="profileVerifiedTickContainer"></span>
            </div>
            <div class="profile-bio" id="profileBio">
                <span id="bioText">Tell us about yourself...</span>
                <i class="fas fa-edit bio-edit-icon" id="bioEditIcon" title="Edit Bio"></i>
            </div>
            <div class="profile-stats">
                <div class="stat-item">
                    <span class="stat-value" id="postsCount">0</span>
                    <span>Posts</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="followersCount">0</span>
                    <span>Followers</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="followingCount">0</span>
                    <span>Following</span>
                </div>
            </div>
        </div>

        <div class="profile-posts-section">
            <h2>My Posts</h2>
            <div id="userPostsList">
                <p class="no-posts">No posts to display yet.</p>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="nav-icon" id="homeIcon">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </div>
        <div class="nav-icon" id="requestsIcon">
            <i class="fas fa-bell"></i>
            <span>Requests</span>
        </div>
        <div class="nav-icon" id="plusIcon">
            <i class="fas fa-plus-circle"></i>
            <span>Add</span>
        </div>
        <div class="nav-icon" id="searchIcon">
            <i class="fas fa-search"></i>
            <span>Search</span>
        </div>
        <div class="nav-icon active" id="profileIcon">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </div>
    </div>

    <div id="infoMessage" class="info-message"></div>

    <div id="avatarModal" class="avatar-modal">
        <div class="avatar-modal-content">
            </div>
    </div>

    <input type="file" id="imageUploadInput" accept="image/*" style="display: none;">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Initialize Firebase with your actual config
        const firebaseConfig = {
            apiKey: "AIzaSyB2mV0bya1fD17kQZQeMP11a9mlK-sVEnc",
            authDomain: "citas-bd0a3.firebaseapp.com",
            databaseURL: "https://citas-bd0a3-default-rtdb.firebaseio.com",
            projectId: "citas-bd0a3",
            storageBucket: "citas-bd0a3.firebasestorage.app",
            messagingSenderId: "1082213903517",
            appId: "1:1082213903517:web:22409e051e5442f37ef874",
            measurementId: "G-TXKMGDLMVB"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const IMGBB_API_KEY = "7184e56bb0953c0545409c441c402a66"; // Your ImgBB API Key

        let currentUser = null;
        let currentUsername = "User";
        let currentUserData = null;
        let selectedAvatar = null;

        const usernameDisplay = document.getElementById('usernameDisplay');
        const headerVerifiedTickContainer = document.getElementById('headerVerifiedTickContainer');
        const dmIcon = document.getElementById('dmIcon');
        const settingsIcon = document.getElementById('settingsIcon');
        const settingsDropdown = document.getElementById('settingsDropdown');
        const requestVerificationBtn = document.getElementById('requestVerificationBtn');
        const accountInfoBtn = document.getElementById('accountInfoBtn');
        const logoutBtn = document.getElementById('logoutBtn');

        const profilePictureDiv = document.getElementById('profilePicture');
        const imageUploadInput = document.getElementById('imageUploadInput');

        const profileUsernameSpan = document.getElementById('profileUsername');
        const profileVerifiedTickContainer = document.getElementById('profileVerifiedTickContainer');
        const profileBioDiv = document.getElementById('profileBio');
        const bioTextSpan = document.getElementById('bioText');
        const bioEditIcon = document.getElementById('bioEditIcon');
        const postsCountSpan = document.getElementById('postsCount');
        const followersCountSpan = document.getElementById('followersCount');
        const followingCountSpan = document.getElementById('followingCount');
        const userPostsListDiv = document.getElementById('userPostsList'); // This element is now added
        const infoMessage = document.getElementById('infoMessage');

        const avatarModal = document.getElementById('avatarModal');

        const homeIcon = document.getElementById('homeIcon');
        const requestsIcon = document.getElementById('requestsIcon');
        const plusIcon = document.getElementById('plusIcon');
        const searchIcon = document.getElementById('searchIcon');
        const profileIcon = document.getElementById('profileIcon');

        const verifiedTickSvg = `
            <svg class="verified-tick" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/>
            </svg>
        `;
        const verifiedTickSvgHeader = `
            <svg class="verified-tick-header" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/>
            </svg>
        `;
        // NEW: Verified tick SVG for posts
        const verifiedTickSvgPost = `
            <svg class="verified-tick-post" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/>
            </svg>
        `;

        const threeDotsSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 512">
                <path d="M64 360a56 56 0 1 0 0 112 56 56 0 1 0 0-112zm0-160a56 56 0 1 0 0 112 56 56 0 1 0 0-112zM120 96c0 30.9-25.1 56-56 56s-56-25.1-56-56S33.1 40 64 40s56 25.1 56 56z"/>
            </svg>
        `;

        // --- Event Listeners for Header Actions ---
        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Error signing out:", error.message);
                showMessage("Error logging out. Please try again.", 'error');
            }
        });

        dmIcon.addEventListener('click', () => {
            window.location.href = 'dm.html';
        });

        settingsIcon.addEventListener('click', (event) => {
            event.stopPropagation();
            toggleDropdown(settingsDropdown);
        });

        requestVerificationBtn.addEventListener('click', async () => {
            if (!currentUserData) {
                showMessage("User data not loaded yet.", 'error');
                return;
            }

            settingsDropdown.classList.remove('show');

            if (currentUserData.isVerified) {
                showMessage("You are already a verified user!", 'success');
                return;
            }

            if (currentUserData.verificationRequested) {
                showMessage("Your verification request is already pending.", 'info');
                return;
            }

            try {
                await db.collection('users').doc(currentUser.uid).update({
                    verificationRequested: true,
                    requestedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showMessage("Verification request sent successfully! Please wait for admin review.", 'success');
                currentUserData.verificationRequested = true;
            } catch (error) {
                console.error("Error sending verification request:", error);
                showMessage("Failed to send verification request. Please try again.", 'error');
            }
        });

        accountInfoBtn.addEventListener('click', () => {
            settingsDropdown.classList.remove('show');
            window.location.href = 'account.html';
        });

        // --- Auth State Observer ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                console.log("User is logged in:", user.email, "UID:", user.uid);
                await loadUserProfile(currentUser.uid);
                loadUserPosts(currentUser.uid); // Now uncommented to load posts
            } else {
                console.log("No user logged in. Redirecting to index.html");
                window.location.href = 'index.html';
            }
        });

        // --- Load User Profile Data (Username, Verification, Counts, Bio, Avatar) ---
        async function loadUserProfile(userId) {
            try {
                db.collection('users').doc(userId).onSnapshot(async (userDoc) => {
                    if (userDoc.exists) {
                        currentUserData = userDoc.data();
                        currentUsername = currentUserData.username || "User";
                        usernameDisplay.textContent = currentUsername;
                        profileUsernameSpan.textContent = currentUsername;

                        const avatarPath = currentUserData.avatar || '';
                        updateProfilePicture(avatarPath);

                        const userBio = currentUserData.bio || "Tell us about yourself...";
                        bioTextSpan.textContent = userBio;

                        if (currentUserData.isVerified) {
                            headerVerifiedTickContainer.innerHTML = verifiedTickSvgHeader;
                            profileVerifiedTickContainer.innerHTML = verifiedTickSvg;
                        } else {
                            headerVerifiedTickContainer.innerHTML = '';
                            profileVerifiedTickContainer.innerHTML = '';
                        }

                        // Fetch posts count from the 'posts' collection
                        const postsSnapshot = await db.collection('posts').where('userId', '==', userId).get();
                        postsCountSpan.textContent = postsSnapshot.size;

                        followersCountSpan.textContent = (currentUserData.followers && currentUserData.followers.length) || 0;
                        followingCountSpan.textContent = (currentUserData.following && currentUserData.following.length) || 0;

                    } else {
                        usernameDisplay.textContent = "User";
                        profilePictureDiv.innerHTML = "U" + `<i class="fas fa-pencil-alt edit-icon" id="editAvatarIcon" title="Change Avatar"></i>`;
                        profileUsernameSpan.textContent = "User Not Found";
                        bioTextSpan.textContent = "Error loading bio...";
                        headerVerifiedTickContainer.innerHTML = '';
                        profileVerifiedTickContainer.innerHTML = '';
                        console.error("User document not found for:", userId);
                    }
                }, (error) => {
                    console.error("Error listening to user profile:", error);
                    usernameDisplay.textContent = "Error";
                    profilePictureDiv.innerHTML = "?" + `<i class="fas fa-pencil-alt edit-icon" id="editAvatarIcon" title="Change Avatar"></i>`;
                    profileUsernameSpan.textContent = "Error Loading Profile";
                    bioTextSpan.textContent = "Error loading bio...";
                    postsCountSpan.textContent = "N/A";
                    followersCountSpan.textContent = "N/A";
                    followingCountSpan.textContent = "N/A";
                });
            } catch (error) {
                console.error("Error setting up user profile listener:", error);
            }
        }

        // Function to update the profile picture display and attach the edit icon listener
        function updateProfilePicture(avatarPath) {
            profilePictureDiv.innerHTML = '';
            if (avatarPath) {
                const img = document.createElement('img');
                img.src = avatarPath;
                img.alt = "Profile Avatar";
                profilePictureDiv.appendChild(img);
            } else {
                const firstLetter = currentUsername.charAt(0).toUpperCase();
                profilePictureDiv.textContent = firstLetter;
            }

            let editIcon = profilePictureDiv.querySelector('#editAvatarIcon');
            if (!editIcon) {
                editIcon = document.createElement('i');
                editIcon.classList.add('fas', 'fa-pencil-alt', 'edit-icon');
                editIcon.id = 'editAvatarIcon';
                editIcon.title = 'Change Avatar';
                profilePictureDiv.appendChild(editIcon);
            }
            editIcon.removeEventListener('click', showAvatarOptionsModalDirectly);
            editIcon.addEventListener('click', showAvatarOptionsModalDirectly);
        }

        // --- NEW: Function to show the initial avatar options modal ---
        function showAvatarOptionsModalDirectly() {
            const avatarModalContent = document.querySelector('#avatarModal .avatar-modal-content');

            avatarModalContent.innerHTML = `
                <h3>Choose Profile Picture Action</h3>
                <div class="avatar-modal-actions" style="flex-direction: column; gap: 15px;">
                    <button class="save-avatar-btn" id="modalChangeAvatarBtn" style="background-color: #007bff; color: white;">Change Pre-defined Avatar</button>
                    <button class="cancel-avatar-btn" id="modalUploadProfilePictureBtn" style="background-color: #28a745; color: white;">Upload Custom Picture</button>
                    <button class="cancel-avatar-btn" id="modalCancelBtn" style="background-color: #6c757d; color: white;">Cancel</button>
                </div>
            `;

            document.getElementById('modalChangeAvatarBtn').addEventListener('click', () => {
                showOriginalAvatarSelectionUI();
            });

            document.getElementById('modalUploadProfilePictureBtn').addEventListener('click', () => {
                avatarModal.style.display = 'none';
                imageUploadInput.click();
            });

            document.getElementById('modalCancelBtn').addEventListener('click', () => {
                avatarModal.style.display = 'none';
            });

            avatarModal.style.display = 'flex';
        }

        // --- NEW: Function to show the original pre-defined avatar selection UI ---
        function showOriginalAvatarSelectionUI() {
            const avatarModalContent = document.querySelector('#avatarModal .avatar-modal-content');
            avatarModalContent.innerHTML = `
                <h3>Choose Your Avatar</h3>
                <div class="avatar-options">
                    <div class="avatar-option" data-avatar="Man.svg">
                        <img src="Man.svg" alt="Man Avatar">
                    </div>
                    <div class="avatar-option" data-avatar="Women.svg">
                        <img src="Women.svg" alt="Woman Avatar">
                    </div>
                    <div class="avatar-option" data-avatar="maleemploye.svg">
                        <img src="maleemploye.svg" alt="Male Employee Avatar">
                    </div>
                    <div class="avatar-option" data-avatar="girlemploye.svg">
                        <img src="girlemploye.svg" alt="Girl Employee Avatar">
                    </div>
                </div>
                <div class="avatar-modal-actions">
                    <button class="save-avatar-btn">Save Avatar</button>
                    <button class="cancel-avatar-btn">Cancel</button>
                </div>
            `;

            const newAvatarOptions = avatarModalContent.querySelectorAll('.avatar-option');
            newAvatarOptions.forEach(option => {
                option.addEventListener('click', () => {
                    newAvatarOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedAvatar = option.dataset.avatar;
                });
            });

            avatarModalContent.querySelector('.save-avatar-btn').addEventListener('click', saveAvatarBtnClickHandler);
            avatarModalContent.querySelector('.cancel-avatar-btn').addEventListener('click', cancelAvatarBtnClickHandler);

            if (currentUserData && currentUserData.avatar) {
                newAvatarOptions.forEach(option => {
                    if (currentUserData.avatar === option.dataset.avatar) {
                        option.classList.add('selected');
                        selectedAvatar = option.dataset.avatar;
                    }
                });
            } else {
                selectedAvatar = null;
            }
        }

        // --- Click handlers for Avatar Save/Cancel buttons (defined once to be re-used) ---
        const saveAvatarBtnClickHandler = async () => {
            if (selectedAvatar && currentUser) {
                try {
                    await db.collection('users').doc(currentUser.uid).update({
                        avatar: selectedAvatar
                    });
                    showMessage('Avatar updated successfully!', 'success');
                    avatarModal.style.display = 'none';
                    selectedAvatar = null;
                } catch (error) {
                    console.error('Error updating avatar:', error);
                    showMessage('Failed to update avatar.', 'error');
                }
            } else {
                showMessage('Please select an avatar to save.', 'info');
            }
        };

        const cancelAvatarBtnClickHandler = () => {
            avatarModal.style.display = 'none';
            selectedAvatar = null;
        };


        imageUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                showMessage('No file selected.', 'info');
                return;
            }

            if (!file.type.startsWith('image/')) {
                showMessage('Please upload an image file.', 'error');
                return;
            }

            showMessage('Uploading image...', 'info');
            try {
                const uploadedImageUrl = await uploadImageToImgBB(file);
                if (uploadedImageUrl) {
                    await db.collection('users').doc(currentUser.uid).update({
                        avatar: uploadedImageUrl
                    });
                    showMessage('Profile picture updated successfully!', 'success');
                } else {
                    showMessage('Image upload failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error uploading profile picture:', error);
                showMessage('Failed to upload profile picture: ' + error.message, 'error');
            } finally {
                imageUploadInput.value = '';
            }
        });

        async function uploadImageToImgBB(file) {
            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`ImgBB upload failed: ${response.status} ${response.statusText} - ${errorText}`);
                }

                const data = await response.json();
                if (data.success) {
                    return data.data.url;
                } else {
                    throw new Error(data.error.message || 'ImgBB upload failed due to an unknown error.');
                }
            } catch (error) {
                console.error("Error uploading to ImgBB:", error);
                throw error;
            }
        }

        // Close modal if clicked outside content
        window.addEventListener('click', (event) => {
            if (event.target == avatarModal) {
                avatarModal.style.display = 'none';
                selectedAvatar = null;
            }
            if (!event.target.closest('.dropdown-content') && !event.target.closest('.post-options-menu') && !event.target.closest('.settings-icon')) {
                document.querySelectorAll('.dropdown-content.show').forEach(openDropdown => {
                    openDropdown.classList.remove('show');
                });
            }
        });

        // --- Handle Bio Edit ---
        bioEditIcon.addEventListener('click', () => {
            const currentBio = bioTextSpan.textContent === "Tell us about yourself..." ? "" : bioTextSpan.textContent;
            const originalBio = currentBio;

            const textarea = document.createElement('textarea');
            textarea.classList.add('profile-bio-textarea');
            textarea.value = currentBio;
            bioTextSpan.replaceWith(textarea);
            bioEditIcon.style.display = 'none';

            const bioEditControls = document.createElement('div');
            bioEditControls.classList.add('bio-edit-controls');
            bioEditControls.innerHTML = `
                <button class="save-btn">Save</button>
                <button class="cancel-btn">Cancel</button>
            `;
            profileBioDiv.classList.add('editing');
            profileBioDiv.appendChild(bioEditControls);

            bioEditControls.querySelector('.save-btn').addEventListener('click', async () => {
                const newBio = textarea.value.trim();
                if (newBio !== originalBio) {
                    try {
                        await db.collection('users').doc(currentUser.uid).update({
                            bio: newBio
                        });
                        showMessage('Bio updated successfully!', 'success');
                    } catch (error) {
                        console.error('Error updating bio:', error);
                        showMessage('Failed to update bio.', 'error');
                    }
                }
                revertBioToDisplayMode(newBio || "Tell us about yourself...");
            });

            bioEditControls.querySelector('.cancel-btn').addEventListener('click', () => {
                revertBioToDisplayMode(originalBio || "Tell us about yourself...");
            });
        });

        // Helper function to revert bio back to display mode
        function revertBioToDisplayMode(bioContent) {
            const textarea = profileBioDiv.querySelector('.profile-bio-textarea');
            const bioEditControls = profileBioDiv.querySelector('.bio-edit-controls');

            if (textarea) textarea.replaceWith(bioTextSpan);
            if (bioEditControls) bioEditControls.remove();

            bioTextSpan.textContent = bioContent;
            bioEditIcon.style.display = '';
            profileBioDiv.classList.remove('editing');
        }

        // --- NEW: Load User's Posts ---
        async function loadUserPosts(userId) {
            userPostsList.innerHTML = '<p class="no-posts">Loading posts...</p>';
            try {
                // Fetch posts from Firestore, ordered by timestamp descending, filtered by userId
                db.collection('posts')
                    .where('userId', '==', userId)
                    .orderBy('timestamp', 'desc')
                    .onSnapshot(async (querySnapshot) => {
                        userPostsList.innerHTML = ''; // Clear previous posts

                        if (querySnapshot.empty) {
                            userPostsList.innerHTML = '<p class="no-posts">No posts from you yet.</p>';
                            return;
                        }

                        // Fetch current user's liked posts to show liked state
                        const currentUserLikesDoc = await db.collection('userLikes').doc(currentUser.uid).get();
                        const likedPostIds = currentUserLikesDoc.exists && currentUserLikesDoc.data().likes ? 
                                            currentUserLikesDoc.data().likes : [];

                        // These variables (currentUsername, currentUserData.avatar, currentUserData.isVerified)
                        // are already available globally from loadUserProfile
                        const userDisplayName = currentUsername;
                        const userAvatar = currentUserData.avatar || '';
                        const isUserVerified = currentUserData.isVerified || false;

                        querySnapshot.forEach(doc => {
                            const postData = doc.data();
                            const postId = doc.id;
                            const content = postData.content;
                            const imageUrl = postData.imageUrl;
                            const timestamp = postData.timestamp ? postData.timestamp.toDate() : new Date();
                            const likesCount = postData.likesCount || 0;

                            const isLiked = likedPostIds.includes(postId);

                            let postAvatarContent;
                            if (userAvatar) {
                                postAvatarContent = `<img src="${userAvatar}" alt="Profile Avatar">`;
                            } else {
                                postAvatarContent = userDisplayName.charAt(0).toUpperCase();
                            }
                            
                            const postElement = document.createElement('div');
                            postElement.classList.add('post-item'); // Changed from post-card to post-item
                            postElement.innerHTML = `
                                <div class="post-header">
                                    <div class="user-info-in-post">
                                        <div class="user-avatar-in-post">${postAvatarContent}</div>
                                        <span class="username-display">${userDisplayName}</span>
                                        ${isUserVerified ? verifiedTickSvgPost : ''}
                                    </div>
                                    <div class="post-options-menu" data-post-id="${postId}">
                                        ${threeDotsSvg}
                                        <div class="dropdown-content">
                                            <button class="edit-post-btn" data-post-id="${postId}">Edit Post</button>
                                            <button class="delete-post-btn" data-post-id="${postId}">Delete Post</button>
                                        </div>
                                    </div>
                                </div>
                                <p class="post-content" data-original-content="${content}">${content}</p>
                                ${imageUrl ? `<img src="${imageUrl}" alt="Post Image" class="post-image">` : ''}
                                <div class="post-actions">
                                    <button class="like-btn ${isLiked ? 'liked' : ''}" data-post-id="${postId}">
                                        <i class="${isLiked ? 'fas' : 'far'} fa-heart"></i>
                                        <span>${likesCount}</span>
                                    </button>
                                    <button class="comment-btn" data-post-id="${postId}">
                                        <i class="far fa-comment"></i>
                                        <span></span> </button>
                                </div>
                                <div class="post-time-bottom">${formatTimestamp(timestamp)}</div>
                            `;
                            userPostsList.appendChild(postElement);
                        });

                        // Attach event listeners to newly created posts
                        userPostsList.querySelectorAll('.like-btn').forEach(button => {
                            button.addEventListener('click', handleLike);
                        });
                        userPostsList.querySelectorAll('.comment-btn').forEach(button => {
                            button.addEventListener('click', handleComment);
                        });
                        userPostsList.querySelectorAll('.post-options-menu').forEach(menu => {
                            menu.addEventListener('click', (event) => toggleDropdown(menu.querySelector('.dropdown-content'), event));
                        });
                        userPostsList.querySelectorAll('.edit-post-btn').forEach(button => {
                            button.addEventListener('click', handleEditPost);
                        });
                        userPostsList.querySelectorAll('.delete-post-btn').forEach(button => {
                            button.addEventListener('click', handleDeletePost);
                        });

                    }, (error) => {
                        console.error("Error loading user's posts with snapshot:", error);
                        userPostsList.innerHTML = '<p class="no-posts error">Error loading posts. Please try again.</p>';
                    });

            } catch (error) {
                console.error("Initial error fetching user's posts:", error);
                userPostsList.innerHTML = '<p class="no-posts error">Error loading posts. Please try again.</p>';
            }
        }

        // --- Handle Like Functionality ---
        async function handleLike(event) {
            if (!currentUser) {
                showMessage('You must be logged in to like posts.', 'error');
                return;
            }

            const likeButton = event.currentTarget;
            const postId = likeButton.dataset.postId;
            let isLiked = likeButton.classList.contains('liked');

            const postRef = db.collection('posts').doc(postId);
            const userLikesRef = db.collection('userLikes').doc(currentUser.uid);

            try {
                await db.runTransaction(async (transaction) => {
                    const postDoc = await transaction.get(postRef);
                    const userLikesDoc = await transaction.get(userLikesRef);

                    if (!postDoc.exists) throw "Post does not exist!";

                    const currentLikes = postDoc.data().likesCount || 0;
                    
                    if (isLiked) {
                        const newLikes = Math.max(0, currentLikes - 1);
                        transaction.update(postRef, { likesCount: newLikes });
                        if (userLikesDoc.exists) {
                            transaction.update(userLikesRef, {
                                likes: firebase.firestore.FieldValue.arrayRemove(postId)
                            });
                        }
                        likeButton.classList.remove('liked');
                        likeButton.querySelector('i').classList.replace('fas', 'far');
                        likeButton.querySelector('span').textContent = newLikes;
                    } else {
                        const newLikes = currentLikes + 1;
                        transaction.update(postRef, { likesCount: newLikes });
                        if (userLikesDoc.exists) {
                            transaction.update(userLikesRef, {
                                likes: firebase.firestore.FieldValue.arrayUnion(postId)
                            });
                        } else {
                            transaction.set(userLikesRef, { likes: [postId] });
                        }
                        likeButton.classList.add('liked');
                        likeButton.querySelector('i').classList.replace('far', 'fas');
                        likeButton.querySelector('span').textContent = newLikes;
                    }
                });

            } catch (error) {
                console.error("Error liking/unliking post:", error);
                showMessage('Failed to update like status. Please try again.', 'error');
            }
        }

        // --- Handle Comment Functionality ---
        function handleComment(event) {
            const postId = event.currentTarget.dataset.postId;
            window.location.href = `comments.html?postId=${postId}`;
        }

        // --- Handle Edit Post ---
        async function handleEditPost(event) {
            const postId = event.currentTarget.dataset.postId;
            const postElement = event.currentTarget.closest('.post-item');
            const postContentElement = postElement.querySelector('.post-content');
            const dropdown = event.currentTarget.closest('.dropdown-content');

            // Hide the dropdown immediately
            if (dropdown) {
                dropdown.classList.remove('show');
            }

            // Ensure we are not already editing this post
            if (postContentElement.classList.contains('editing')) {
                return;
            }

            const originalContent = postContentElement.dataset.originalContent || postContentElement.textContent.trim();

            // Create textarea for editing
            const textarea = document.createElement('textarea');
            textarea.classList.add('post-content', 'editing');
            textarea.value = originalContent;

            // Create Save and Cancel buttons
            const editControls = document.createElement('div');
            editControls.classList.add('edit-controls');
            editControls.innerHTML = `
                <button class="save-btn">Save</button>
                <button class="cancel-btn">Cancel</button>
            `;

            // Replace content and append controls
            postContentElement.replaceWith(textarea);
            postElement.appendChild(editControls);

            // Hide three dots menu while editing
            postElement.querySelector('.post-options-menu').style.display = 'none';
            
            // Event listeners for Save/Cancel
            editControls.querySelector('.save-btn').addEventListener('click', async () => {
                const newContent = textarea.value.trim();
                if (newContent !== originalContent) {
                    try {
                        await db.collection('posts').doc(postId).update({
                            content: newContent
                        });
                        showMessage('Post updated successfully!', 'success');
                    } catch (error) {
                        console.error('Error updating post:', error);
                        showMessage('Failed to update post. Please try again.', 'error');
                    }
                }
                // Revert to display mode
                revertPostToDisplayMode(postElement, postId, newContent || originalContent);
            });

            editControls.querySelector('.cancel-btn').addEventListener('click', () => {
                // Revert to display mode with original content
                revertPostToDisplayMode(postElement, postId, originalContent);
            });
        }

        // Helper function to revert post content back to display mode
        function revertPostToDisplayMode(postElement, postId, content) {
            const textarea = postElement.querySelector('.post-content.editing');
            const editControls = postElement.querySelector('.edit-controls');

            const newContentDisplay = document.createElement('p');
            newContentDisplay.classList.add('post-content');
            newContentDisplay.textContent = content;
            newContentDisplay.dataset.originalContent = content; // Update original content

            if (textarea) textarea.replaceWith(newContentDisplay);
            if (editControls) editControls.remove();

            // Show three dots menu again
            postElement.querySelector('.post-options-menu').style.display = '';
        }

        // --- Handle Delete Post ---
        async function handleDeletePost(event) {
            const postId = event.currentTarget.dataset.postId;
            const dropdown = event.currentTarget.closest('.dropdown-content');

            // Hide the dropdown immediately
            if (dropdown) {
                dropdown.classList.remove('show');
            }

            if (confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
                try {
                    // Delete the post document
                    await db.collection('posts').doc(postId).delete();

                    // Remove the post from any userLikes documents where it might be liked
                    const userLikesSnapshot = await db.collection('userLikes').where('likes', 'array-contains', postId).get();
                    const batch = db.batch();
                    userLikesSnapshot.forEach(doc => {
                        const userLikesRef = db.collection('userLikes').doc(doc.id);
                        batch.update(userLikesRef, {
                            likes: firebase.firestore.FieldValue.arrayRemove(postId)
                        });
                    });
                    await batch.commit();

                    showMessage('Post deleted successfully!', 'success');
                    // The onSnapshot in loadUserPosts will automatically remove the post from the UI
                } catch (error) {
                    console.error('Error deleting post:', error);
                    showMessage('Failed to delete post. Please try again.', 'error');
                }
            }
        }

        // Helper function to check if user liked a post
        function isUserLikedPost(postLikesArray, userId) {
            return postLikesArray && Array.isArray(postLikesArray) && postLikesArray.includes(userId);
        }

        // --- Toggle Dropdown Menu (Universal Function) ---
        function toggleDropdown(dropdownElement, event = null) {
            if (event) {
                event.stopPropagation();
            }

            document.querySelectorAll('.dropdown-content.show').forEach(openDropdown => {
                if (openDropdown !== dropdownElement) {
                    openDropdown.classList.remove('show');
                }
            });

            dropdownElement.classList.toggle('show');
        }

        // Helper function to format timestamp
        function formatTimestamp(date) {
            const now = new Date();
            const diffSeconds = Math.floor((now - date) / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffSeconds < 60) {
                return "just now";
            } else if (diffMinutes < 60) {
                return `${diffMinutes}m ago`;
            } else if (diffHours < 24) {
                return `${diffHours}h ago`;
            } else if (diffDays < 7) {
                return `${diffDays}d ago`;
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            }
        }

        // --- Info Message Display Function ---
        let messageTimeout;
        function showMessage(msg, type) {
            clearTimeout(messageTimeout);
            infoMessage.textContent = msg;
            infoMessage.className = `info-message show ${type}`;

            messageTimeout = setTimeout(() => {
                infoMessage.classList.remove('show');
            }, 3000);
        }

        // --- Bottom Nav Icon Click Handlers ---
        homeIcon.addEventListener('click', () => {
            window.location.href = 'home.html';
        });
        requestsIcon.addEventListener('click', () => {
            window.location.href = 'requests.html';
        });
        plusIcon.addEventListener('click', () => {
            window.location.href = 'post.html';
        });
        searchIcon.addEventListener('click', () => {
            window.location.href = 'search.html';
        });
        profileIcon.addEventListener('click', () => {
            window.location.href = 'profile.html';
        });

        // Set the active icon on page load based on current page
        document.addEventListener('DOMContentLoaded', () => {
            const path = window.location.pathname.split('/').pop();
            if (path === 'home.html' || path === '') {
                updateActiveNavIcon(homeIcon);
            } else if (path === 'requests.html') {
                updateActiveNavIcon(requestsIcon);
            } else if (path === 'post.html') {
                updateActiveNavIcon(plusIcon);
            } else if (path === 'search.html') {
                updateActiveNavIcon(searchIcon);
            } else if (path === 'profile.html') {
                updateActiveNavIcon(profileIcon);
            }
        });

        // Helper function to update active icon
        function updateActiveNavIcon(clickedIcon) {
            const allNavIcons = document.querySelectorAll('.footer .nav-icon');
            allNavIcons.forEach(icon => {
                icon.classList.remove('active');
            });
            clickedIcon.classList.add('active');
        }
    </script>
</body>
    </html>
